{% extends 'layout.html' %} {% block content %}
<div class="container">
  <h1>Corpora Examples</h1>
  
  <div class="example-selector" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
    <form action="{{ url_for('examples') }}" method="GET" id="corpusForm">
        <div style="margin-bottom: 1.5rem;">
            <label for="fileSelect" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Select a Book to Analyze:</label>
            <select name="file" id="fileSelect" onchange="this.form.submit()" style="width: 100%; padding: 0.75rem; border-radius: 4px; border: 1px solid #ced4da; font-size: 1rem; cursor: pointer;">
                {% for file in files %}
                    <option value="{{ file }}" {% if file == selected_file %}selected{% endif %}>{{ file }}</option>
                {% endfor %}
            </select>
        </div>

        <label class="options-label"> Text Analysis Options </label>
        <div class="options">
          <div class="toggle-group">
            <label class="switch">
              <input type="checkbox" name="remove_punctuation" onchange="this.form.submit()" {{ 'checked' if options.remove_punctuation }}>
              <span class="slider round"></span>
            </label>
            <span>Remove Punctuation</span>
          </div>
          <div class="toggle-group">
            <label class="switch">
              <input type="checkbox" name="filter_alpha" onchange="this.form.submit()" {{ 'checked' if options.filter_alpha }}>
              <span class="slider round"></span>
            </label>
            <span>Filter Non-Alphabetic</span>
          </div>
          <div class="toggle-group">
            <label class="switch">
              <input type="checkbox" name="case_sensitive" onchange="this.form.submit()" {{ 'checked' if options.case_sensitive }}>
              <span class="slider round"></span>
            </label>
            <span>Case Sensitive</span>
          </div>
          <div class="toggle-group">
            <label class="switch">
              <input type="checkbox" name="remove_stop_words" onchange="this.form.submit()" {{ 'checked' if options.remove_stop_words }}>
              <span class="slider round"></span>
            </label>
            <span>Remove Stop Words</span>
          </div>
          <div style="grid-column: 1 / -1; margin-top: 0.5rem;">
            <label for="words_to_exclude" style="display: block; margin-bottom: 0.25rem; font-weight: normal;">Words to exclude (comma separated)</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="words_to_exclude" name="words_to_exclude" placeholder="e.g. apple, banana" value="{{ options.words_to_exclude }}" style="flex-grow: 1;">
                <input type="submit" value="Apply" class="btn" style="padding: 0.5rem 1rem;">
            </div>
          </div>
        </div>
    </form>
  </div>

  <div class="result">
      <h2>Analysis Results: {{ selected_file }}</h2>
      
      <div class="visualization-container">
          <div class="viz-header">
              <h3>Token Frequency</h3>
              <div class="chart-toggle">
                  <span class="toggle-label">Before filtering stopwords</span>
                  <label class="switch tiny">
                      <input type="checkbox" id="chartDataToggle">
                      <span class="slider round"></span>
                  </label>
                  <span class="toggle-label">After filtering stopwords</span>
              </div>
          </div>
          <div class="chart-wrapper">
              <canvas id="tokenChart"></canvas>
          </div>
      </div>

      <div class="visualization-container" style="margin-top: 2rem;">
          <div class="viz-header">
              <div style="display: flex; flex-direction: column;">
                <h3 style="margin-bottom: 0.25rem;">Zipf Distribution (Log-Log)</h3>
                <span style="font-size: 0.85rem; color: #666;">Rank vs Frequency Analysis</span>
              </div>
          </div>
          <div class="chart-wrapper" style="overflow: hidden; height: 500px;">
              <canvas id="zipfChart"></canvas>
          </div>
          <div class="explanation-box" style="margin-top: 1.5rem; padding: 1rem; background: #fdfdfd; border-left: 4px solid #3498db; border-radius: 4px;">
              <p style="margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Natural language follows Zipf’s Law</p>
              <ul style="margin-left: 1.5rem; font-size: 0.95rem; color: #444;">
                  <li><strong>Global Structure:</strong> A straight line in log–log space indicates power-law behavior.</li>
                  <li><strong>Linguistic Insight:</strong> This chart reveals how a few words dominate while most occur rarely.</li>
                  <li><strong>Analysis:</strong> Deviations at the <em>Head</em> (very common words) or <em>Tail</em> (rare words) can reveal genre, text size, or preprocessing effects.</li>
              </ul>
          </div>
      </div>
  </div>

  <script>
      const rawChartData = {{ chart_data | tojson | safe }};
      const rawZipfData = {{ zipf_data | tojson | safe }};
      
      // Token Frequency Chart
      const ctx = document.getElementById('tokenChart').getContext('2d');
      const chartCanvas = document.getElementById('tokenChart');
      
      let currentData = rawChartData.after;
      let currentZipf = rawZipfData.after;

      function updateChartWidth(data) {
          const minBarWidth = 50;
          const calculatedWidth = data.labels.length * minBarWidth;
          chartCanvas.parentElement.style.width = '100%'; 
          chartCanvas.style.width = Math.max(calculatedWidth, chartCanvas.parentElement.offsetWidth) + 'px';
      }
      
      const tokenChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: currentData.labels,
              datasets: [{
                  label: 'Frequency',
                  data: currentData.values,
                  backgroundColor: 'rgba(52, 152, 219, 0.7)',
                  borderColor: 'rgba(52, 152, 219, 1)',
                  borderWidth: 1,
                  borderRadius: 4
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      grid: { color: 'rgba(0, 0, 0, 0.05)' }
                  },
                  x: {
                      grid: { display: false }
                  }
              }
          }
      });

      // Zipf Chart
      const zipfCtx = document.getElementById('zipfChart').getContext('2d');
      const zipfChart = new Chart(zipfCtx, {
          type: 'line',
          data: {
              labels: currentZipf.ranks,
              datasets: [
                  {
                      label: 'Empirical Frequency',
                      data: currentZipf.frequencies,
                      borderColor: 'rgba(52, 152, 219, 1)',
                      backgroundColor: 'rgba(52, 152, 219, 0.2)',
                      borderWidth: 2,
                      pointRadius: 3,
                      pointHoverRadius: 6,
                      showLine: true,
                      fill: false,
                  },
                  {
                      label: 'Theoretical Zipf (1/r)',
                      data: currentZipf.theoretical,
                      borderColor: 'rgba(231, 76, 60, 0.8)',
                      borderDash: [5, 5],
                      borderWidth: 1,
                      pointRadius: 0,
                      fill: false,
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              const rank = context.label;
                              const freq = context.raw;
                              const word = currentZipf.labels[context.dataIndex];
                              return `Rank ${rank} (${word}): ${freq}`;
                          }
                      }
                  }
              },
              scales: {
                  x: {
                      type: 'logarithmic',
                      title: { display: true, text: 'Rank (Log Scale)' },
                      min: 1
                  },
                  y: {
                      type: 'logarithmic',
                      title: { display: true, text: 'Frequency (Log Scale)' }
                  }
              }
          }
      });

      function refreshCharts(newData, newZipf) {
          // Update Token Chart
          updateChartWidth(newData);
          tokenChart.data.labels = newData.labels;
          tokenChart.data.datasets[0].data = newData.values;
          tokenChart.update();

          // Update Zipf Chart
          currentZipf = newZipf; // Update local reference for tooltips
          zipfChart.data.labels = newZipf.ranks;
          zipfChart.data.datasets[0].data = newZipf.frequencies;
          zipfChart.data.datasets[1].data = newZipf.theoretical;
          zipfChart.update();
      }

      document.getElementById('chartDataToggle').addEventListener('change', function(e) {
          const isAfter = e.target.checked;
          const newData = isAfter ? rawChartData.after : rawChartData.before;
          const newZipf = isAfter ? rawZipfData.after : rawZipfData.before;
          refreshCharts(newData, newZipf);
      });

      // Initial call
      updateChartWidth(currentData);
      document.getElementById('chartDataToggle').checked = true;
  </script>
</div>
{% endblock %}

